# AGENTS.md

## Проект: Task Tracker (sus)

**Стек:** Gleam + Lustre (server components) + Mist (HTTP сервер) + PostgreSQL (pog + squirrel + cigogne)

**Запуск:**
```bash
# 1. Start PostgreSQL (if not running)
# 2. Set DATABASE_URL (or use default: postgres://postgres@localhost:5432/sus)
export DATABASE_URL="postgres://postgres@localhost:5432/sus"

# 3. Apply migrations
gleam run -m cigogne all

# 4. Generate type-safe SQL (only needed after changing .sql files)
gleam run -m squirrel

# 5. Run the app
gleam run   # http://localhost:1234

gleam test  # run tests
```

**Важно:** Не запускай сервер (`gleam run`) самостоятельно. Предоставь команду пользователю, чтобы он запустил её сам.

## Архитектура

### Структура
- `src/sus.gleam` - entry point, pog pool setup, HTTP server startup
- `src/router.gleam` - routing: HTML, JS runtime, WebSocket
- `src/pages/tasks.gleam` - Lustre component (Model/Update/View)
- `src/store/task_store.gleam` - task storage backed by PostgreSQL
- `src/types/task.gleam` - Task, TaskStatus types + JSON encoding + time utilities
- `src/sql.gleam` - **auto-generated** by squirrel, type-safe SQL query functions
- `src/sql/*.sql` - raw SQL queries (source for squirrel code generation)
- `src/components/layout.gleam` - shared layout + inline CSS
- `src/middleware/logger.gleam` - HTTP request logging middleware
- `priv/migrations/` - database migrations (managed by cigogne)
- `priv/cigogne.toml` - cigogne configuration

### Ключевые паттерны

**1. Server Components (Lustre)**
- Компонент работает на сервере, UI рендерится через WebSocket
- `pages/tasks.gleam` - полноценное Lustre приложение (init/update/view)
- WebSocket endpoint: `/ws/tasks`

**2. Database (PostgreSQL + Squirrel + Cigogne)**

**Migrations (cigogne):**
- Migration files in `priv/migrations/` with format `<timestamp>-<name>.sql`
- Each file has `--- migration:up` and `--- migration:down` sections
- Commands: `gleam run -m cigogne all|up|down|show|new --name NAME`

**Type-safe SQL (squirrel):**
- Write raw SQL in `src/sql/*.sql` files (one query per file)
- Run `gleam run -m squirrel` to generate `src/sql.gleam`
- Squirrel connects to the database to infer types and generate decoders
- **Do NOT edit `src/sql.gleam` manually** — it is auto-generated
- TaskStatus enum is auto-generated from PostgreSQL's `task_status` enum

**Task Store (pog):**
- `task_store.gleam` wraps pog connection in opaque `TaskStore` type
- All queries go through squirrel-generated functions in `sql.gleam`
- Public API preserved: `get_all`, `get_by_id`, `create`, `delete`, `start_timer`, `stop_timer`, `complete_task`

**3. Таймер задач (Time Tracking)**

The timer uses a dual-field approach to track time without periodic updates:

```gleam
type Task {
  time_spent_seconds: Int,           // Accumulated time (stored in DB)
  started_at: Option(Timestamp),     // When timer started (NULL when paused)
  status: TaskStatus,                // NotStarted | InProgress | Paused | Completed
}
```

**How it works:**
- `start_timer(store, id, current_time)` - Sets `started_at` and status = InProgress (SQL update with status filter)
- `stop_timer(store, id, current_time)` - Calculates elapsed seconds, adds to `time_spent_seconds`, sets `started_at = NULL` and status = Paused
- `complete_task(store, id, current_time)` - Handles timer stop + status = Completed in a single SQL query
- **Display calculation**: For active tasks: `time_spent_seconds + (now - started_at)`

**Important**: The timer uses a periodic Tick (every second) to update the UI for active tasks.

**4. HTTP Request Logging**

```gleam
// router.gleam
use <- logger.log_request(request)
```

Format: `METHOD /path STATUS duration_ms`

### Типы данных

```gleam
// TaskStatus (auto-generated by squirrel from PostgreSQL enum)
// Defined in sql.gleam, re-exported via types/task.gleam
NotStarted | InProgress | Completed | Paused

// Task
type Task {
  id: Int,
  name: String,
  description: String,
  status: TaskStatus,
  time_spent_seconds: Int,
  started_at: Option(Timestamp),  // gleam/time/timestamp
  created_at: Timestamp,
}
```

### API хранилища

```gleam
task_store.new(db: pog.Connection) -> TaskStore
task_store.get_all(store) -> List(Task)
task_store.get_by_id(store, id) -> Option(Task)
task_store.create(store, data) -> Option(Task)
task_store.delete(store, id) -> Bool
task_store.start_timer(store, id, current_time: Timestamp) -> Option(Task)
task_store.stop_timer(store, id, current_time: Timestamp) -> Option(Task)
task_store.complete_task(store, id, current_time: Timestamp) -> Option(Task)
```

### SQL файлы (src/sql/)

| Файл | Назначение |
|------|-----------|
| `get_all_tasks.sql` | SELECT all tasks ordered by created_at DESC |
| `get_task_by_id.sql` | SELECT task by id |
| `create_task.sql` | INSERT with name, description; RETURNING * |
| `delete_task.sql` | DELETE by id |
| `start_timer.sql` | UPDATE status + started_at (only if not_started/paused) |
| `stop_timer.sql` | UPDATE status + time_spent_seconds (only if in_progress) |
| `complete_task.sql` | UPDATE status to completed, calculate elapsed if running |

### CSS классы статусов

- `status-not-started` - серая рамка
- `status-in-progress` - синяя рамка
- `status-completed` - зелёная рамка
- `status-paused` - оранжевая рамка

## Code Style

**Important**: All code comments must be written in **English only**. This ensures consistency and makes the codebase accessible to all contributors.

## Ограничения

- Нет валидации входных данных
- Нет аутентификации
- Таймер использует периодический Tick каждую секунду для обновления отображения активных задач
- Требуется запущенный PostgreSQL сервер

## Зависимости

### Runtime
- `lustre` - фреймворк для UI
- `mist` - HTTP/WebSocket сервер
- `gleam_json` - JSON кодирование
- `gleam_otp` - OTP процессы
- `gleam_erlang` - FFI для Erlang
- `pog` - PostgreSQL драйвер
- `gleam_time` - работа с временем (Timestamp)
- `envoy` - чтение переменных окружения
- `cigogne` - миграции БД
- `birl` - дополнительная работа с датами

### Dev
- `gleeunit` - тестирование
- `squirrel` - генерация типобезопасных SQL функций

## Тесты

- `test/sus_test.gleam` - базовые тесты
- Используется `gleeunit` для тестирования
